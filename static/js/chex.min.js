function error(e){console.log("Internal server error: "+e)}function resume(e,t){return t||(t=150),e.length>t?e.substring(0,t)+" ...":e}function showInfoMessage(e){var t=$("#infoPanel").css("visibility","visible").addClass("alert-success").text(e);window.scrollTo(0,0),window.setTimeout(function(){$("#infoPanel").removeClass("alert-success").css("visibility","hidden")},1500)}function showErrorMessage(e){var t=$("#infoPanel").css("visibility","visible").addClass("alert-danger").text(e);window.scrollTo(0,0),window.setTimeout(function(){$("#infoPanel").removeClass("alert-danger").css("visibility","hidden")},1500)}var DOMAIN="";$(document).ready(function(){$(".dropdown-toggle").dropdown(),users.init(),questions.init(),answers.init(),tests.init()});var users=function(){var e={Name:"isNonEmpty",Mail:"isEmail",Tags:"isWordEnumeration"},t={form:"#userEditForm",panel:"#usersList"},n=function(e){$.ajax({url:DOMAIN+"/users/add",type:"post",dataType:"json",data:JSON.stringify(e),success:function(e){e.Error?(showErrorMessage("Error al crear usuario"),console.log(e.Error)):(showInfoMessage("Usuario creado con éxito"),u())},error:error})},r=function(e){$.ajax({url:DOMAIN+"/users/update",type:"post",dataType:"json",data:JSON.stringify(e),success:function(e){e.Error?(showErrorMessage("Error al editar usuario"),console.log(e.Error)):showInfoMessage("Usuario editado con éxito")},error:error})},i=function(){$.ajax({url:DOMAIN+"/users/tags/list",type:"get",dataType:"json",success:function(e){e&&$.each(e,function(e,n){$(t.panel+" .tags").append('<a href="#" class="label label-default">'+n+"</a>")})},error:error})},s=function(e){$.ajax({url:DOMAIN+"/users/list",type:"get",dataType:"json",data:{tags:e.join(",")},success:function(e){!e||e.length==0?$(t.panel+" .results").append('<span class="list-group-item">No hubo resultados</span>'):e.forEach(function(e){$(t.panel+" .results").append('<a href="/users/get?id='+e.Id+'" class="list-group-item">'+e.Name+"</a>")})},error:error})},o=function(){},u=function(){$(t.form).each(function(){this.reset()})},a=function(){var n=$(t.form).serializeObject();n.Tags=n.Tags.split(",").map(function(e){return e.trim()}),n.Tags.clean(""),validator.validate(n,e);if(validator.hasErrors()){showErrorMessage("Existen campos mal formados o sin información");return}return n},f=function(){$(t.form+" #userNewSubmit").click(function(){var e=a();if(!e)return;n(e)}),$(t.form+" #userUpdateSubmit").click(function(){var e=a();if(!e)return;r(e)}),$(t.panel+" .tags").on("click","*",function(e){$(this).toggleClass("label-primary")}),$(t.panel+" .tags").on("click",function(e){tags=[],$(t.panel+" .results").empty(),$(t.panel+" .tags").find(".label-primary").each(function(){tags.push($(this).html())}),tags.length>0&&s(tags)})},l=function(){i(),f(),$(".alert").css("visibility","hidden")};return{init:l}}(),questions=function(){var e={form:"#questEditForm",panel:"#questList"},t=function(e){$.ajax({url:DOMAIN+"/questions/add",type:"post",dataType:"json",data:JSON.stringify(e),success:function(e){e.Error?(showErrorMessage("Error al crear pregunta"),console.log(e.Error)):(showInfoMessage("Pregunta creada con éxito"),o())},error:error})},n=function(e){},r=function(e){$.ajax({url:DOMAIN+"/questions/tags/list",type:"get",dataType:"json",success:function(t){t&&$.each(t,function(t,n){$(e).append('<a href="#" class="label label-default">'+n+"</a>")})},error:error})},i=function(e,t){$.ajax({url:DOMAIN+"/questions/list",type:"get",dataType:"json",data:{tags:t.join(",")},success:function(t){!t||t.length==0?$(e+" .results").append('<span class="list-group-item">No hubo resultados</span>'):t.forEach(function(t){$(e+" .results").append('<li class="list-group-item"><a href="/questions/get?id='+t.Id+'" >'+resume(t.Text)+"</a></li>")})},error:error})},s=function(){},o=function(){$(e.form).each(function(){this.reset()})},u=function(){var t=$(e.form).serializeObject();return t.Tags=t.Tags.split(",").map(function(e){return e.trim()}),t.Tags.clean(""),t},a=function(){$(e.form+" .btn-add").on("click",function(){$(e.form+" .question-options").append('<div class="input-group"><input type="text" class="form-control" name="Options"><span class="input-group-btn"><button type="button" class="btn btn-default btn-del">-</button></div></span>')}),$(e.form).on("click",".btn-del",function(){$(this).closest("div.input-group").remove()}),$(e.form+" #questNewSubmit").click(function(){var e=u();if(!e)return;t(e)}),f(e.panel)},f=function(e){r(e+" .tags"),$(e+" .tags").on("click","*",function(e){$(this).toggleClass("label-primary")}),$(e+" .tags").on("click",function(t){t.preventDefault(),tags=[],$(e+" .results").empty(),$(e+" .tags").find(".label-primary").each(function(){tags.push($(this).html())}),tags.length>0&&i(e,tags)})},l=function(){a()};return{init:l,tags:f}}(),answers=function(){var e={form:"#answerEditForm",panel:"#answerPanel"},t=function(e){$.ajax({url:DOMAIN+"/answers/add",type:"post",dataType:"json",data:JSON.stringify(e),success:function(e){e.Error?(showErrorMessage("Error al crear respuesta"),console.log(e.Error)):showInfoMessage("Respuesta creada con éxito")},error:error})},n=function(e){},r=function(){},i=function(){},s=function(){$(e.form).each(function(){this.reset()})},o=function(){var t=$(e.form).serializeObject();return Array.isArray(t.RawBody)&&(t.RawSolution=t.RawBody.toString()),t},u=function(){$(e.panel+" #solvedPanel").length&&$(e.panel+" #unSolvedPanel").hide(),$(e.panel+" #answerUpdateButton").on("click",function(){$(e.panel+" #solvedPanel").hide(),$(e.panel+" #unSolvedPanel").show()}),$(e.panel+" #answerNewCancel").on("click",function(){$(e.panel+" #unSolvedPanel").hide(),$(e.panel+" #solvedPanel").show()}),$(e.panel+" #answerNewSubmit").on("click",function(){var e=o();if(!e)return;t(e),location.reload()})},a=function(){u()};return{init:a}}(),tests=function(){var e={form:"",panel:""},t=function(e){$.ajax({url:DOMAIN+"/tests/add",type:"post",dataType:"json",data:JSON.stringify(e),success:function(e){e.Error?(showErrorMessage("Error al crear pregunta"),console.log(e.Error)):(showInfoMessage("Pregunta creada con éxito"),o())},error:error})},n=function(e){},r=function(){$("#testSelectQuestionPanel .tags").empty(),questions.tags("#testSelectQuestionPanel")},i=function(e){},s=function(){},o=function(){$(e.form).each(function(){this.reset()})},u=function(){},a=function(){$(e.form+" #testNewSubmit").click(function(){}),$("#addMoreQuests").click(function(){$("#testSelectedQuestionPanel").hide(),$("#testSelectQuestionPanel").show(),r()}),$("#addSelectedQuests").click(function(){$("#testSelectedQuestionPanel").show(),$("#testSelectQuestionPanel").hide()})},f=function(){$("#testSelectQuestionPanel").hide(),$("#testSelectedQuestionPanel ul").empty(),a()};return{init:f}}(),validator={types:{isNonEmpty:{validate:function(e){return e!=""},instructions:"value cannot be empty"},isNumber:{validate:function(e){return!isNaN(e)},instructions:"value must be a number"},isWordEnumeration:{validate:function(e){return/^(\s*\w+\s*,)*\s*\w+\s*$/m.test(e)},instructions:"value must a word without spaces sequence"},isEmail:{validate:function(e){var t=/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;return t.test(e)},instructions:"value must a valid email"}},config:{},messages:[],validate:function(e,t){var n,r,i,s,o;this.messages=[];for(n in e)if(e.hasOwnProperty(n)){i=t[n],s=this.types[i];if(!i)continue;s||console.log("Error: no checker for this type"),o=s.validate(e[n]),o||(r="Invalid value for "+n+":, "+s.instructions,this.messages.push(r))}return this.hasErrors()},hasErrors:function(){return this.messages.length!=0},getErrors:function(){return m=this.messages.join("\n"),this.messages=[],m}};$.fn.serializeObject=function(){var e={},t=this.serializeArray();return $.each(t,function(){e[this.name]!==undefined?(e[this.name].push||(e[this.name]=[e[this.name]]),e[this.name].push(this.value||"")):e[this.name]=this.value||""}),e},Array.prototype.clean=function(e){for(var t=0;t<this.length;t++)this[t]==e&&(this.splice(t,1),t--);return this};